<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin ‚Ä¢ Just Click by Sherry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Primary (plum) from image
                        plum: {
                            500: '#5A2753',
                            600: '#7A3E6C'
                        },
                        // Secondary (mint gradient) from image
                        mint: {
                            50: '#A8E6CF',
                            100: '#DCEEEA',
                            200: '#C9EFDF',
                            300: '#A5E3CB',
                            400: '#76D2B1',
                            500: '#4AB997',
                            600: '#359B80'
                        },
                        // Accent (light lavender) from image
                        lavender: {
                            100: '#E8D5E9',
                            200: '#D4B3D7'
                        },
                        // Text colors
                        text: {
                            primary: '#2E2E2E',
                            muted: '#6B6B6B'
                        }
                    },
                    fontFamily: {
                        display: ['"Playfair Display"', 'serif'],
                        body: ['"Poppins"', 'ui-sans-serif', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'bounce': 'bounce 1s infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-mint-50/30 to-lavender-100/20 text-text-primary font-body min-h-screen">
    <script>
        // Simple client-side guard: redirect to start if not authenticated
        (function(){
            try {
                var ok = localStorage.getItem('adminAuth') === 'true';
                if (!ok) { window.location.replace('./start.html'); }
            } catch (e) {
                try { window.location.replace('./start.html'); } catch {}
            }
        })();
    </script>
    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-mint-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-mint-100 to-mint-200 flex items-center justify-center shadow-lg">
                    <span class="text-plum-500 text-xl">‚åÇ</span>
                </div>
                <div class="leading-tight">
                    <h1 class="text-xl font-display font-bold tracking-tight text-plum-500">Admin Dashboard</h1>
                    <p class="text-xs text-text-muted -mt-0.5">Just Click by Sherry</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-amber-50 text-amber-700 ring-1 ring-amber-200">Admin Mode</span>
                <a href="./index.html" class="text-sm text-plum-500 hover:underline font-medium">Customer View</a>
                <button id="goToStartBtn" class="rounded-2xl px-6 py-3 bg-plum-500 text-white hover:bg-plum-600 transition-all duration-300 hover:scale-105 hover:shadow-xl text-sm font-medium">
                    <span class="flex items-center gap-2">
                        <span>Logout</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-12">
        <div class="flex items-center gap-4 mb-8">
            <button id="tabOrders" class="rounded-2xl px-6 py-3 bg-plum-500 text-white hover:bg-plum-600 transition-all duration-300 hover:scale-105 hover:shadow-xl font-medium">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Orders</span>
                </span>
            </button>
            <button id="tabProducts" class="rounded-2xl px-6 py-3 ring-2 ring-mint-100 hover:ring-plum-500 hover:text-plum-500 transition-all duration-300 hover:scale-105 font-medium">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span>Products</span>
                </span>
            </button>
        </div>

        <!-- Orders Panel -->
        <section id="panelOrders" class="block animate-fade-in">
            <div class="bg-white/70 backdrop-blur-sm rounded-3xl p-8 shadow-xl ring-1 ring-white/40 mb-8">
                <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-8">
                    <h2 class="text-3xl font-display font-bold text-plum-500 flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-mint-100 to-mint-200 rounded-2xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-plum-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        Orders
                    </h2>
                    <div class="flex flex-wrap gap-3 items-center">
                        <input id="searchInput" class="px-4 py-3 rounded-2xl ring-2 ring-mint-100 text-sm focus:outline-none focus:ring-plum-500 bg-white/80 backdrop-blur-sm transition-all duration-300" placeholder="Search orders...">
                        <input id="dateFrom" type="date" class="px-4 py-3 rounded-2xl ring-2 ring-mint-100 text-sm focus:outline-none focus:ring-plum-500 bg-white/80 backdrop-blur-sm transition-all duration-300">
                        <input id="dateTo" type="date" class="px-4 py-3 rounded-2xl ring-2 ring-mint-100 text-sm focus:outline-none focus:ring-plum-500 bg-white/80 backdrop-blur-sm transition-all duration-300">
                        <select id="pageSize" class="px-4 py-3 rounded-2xl ring-2 ring-mint-100 text-sm focus:outline-none focus:ring-plum-500 bg-white/80 backdrop-blur-sm transition-all duration-300">
                            <option value="6">6 per page</option>
                            <option value="12">12 per page</option>
                            <option value="24">24 per page</option>
                        </select>
                        <button id="refreshOrders" class="text-sm rounded-2xl px-6 py-3 ring-2 ring-mint-100 hover:ring-plum-500 hover:text-plum-500 transition-all duration-300 hover:scale-105 font-medium">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                <span>Refresh</span>
                            </span>
                        </button>
                    </div>
                </div>
                <div id="orders" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                <div class="mt-8 flex items-center justify-between">
                    <button id="prevPage" class="rounded-2xl px-6 py-3 ring-2 ring-mint-100 hover:ring-plum-500 transition-all duration-300 hover:scale-105 font-medium">Previous</button>
                    <div id="pageInfo" class="text-sm text-text-muted font-medium">Page 1</div>
                    <button id="nextPage" class="rounded-2xl px-6 py-3 ring-2 ring-mint-100 hover:ring-plum-500 transition-all duration-300 hover:scale-105 font-medium">Next</button>
                </div>
            </div>
        </section>

        <!-- Products Panel -->
        <section id="panelProducts" class="hidden animate-fade-in">
            <div class="bg-white/70 backdrop-blur-sm rounded-3xl p-8 shadow-xl ring-1 ring-white/40">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-display font-bold text-plum-500 flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-mint-100 to-mint-200 rounded-2xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-plum-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                            </svg>
                        </div>
                        Products
                    </h2>
                    <button id="addProductBtn" class="rounded-2xl px-6 py-3 bg-plum-500 text-white hover:bg-plum-600 transition-all duration-300 hover:scale-105 hover:shadow-xl font-medium">
                        <span class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            <span>Add Product</span>
                        </span>
                    </button>
                </div>
                <div id="productsList" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
            </div>
        </section>
    </main>

    <script>
        // Themed Alert Override for Admin (matches shop alerts)
        (function setupAdminAlerts(){
            try {
                let toastContainer = document.getElementById('jcws_toasts');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'jcws_toasts';
                    toastContainer.className = 'fixed z-[9999] bottom-4 right-4 flex flex-col gap-3 pointer-events-none';
                    document.body.appendChild(toastContainer);
                }
                const ICONS = { success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' };
                function createToast(type, message, ms){
                    const kind = (type||'info').toLowerCase();
                    const icon = ICONS[kind] || ICONS.info;
                    const duration = Math.max(2000, Math.min(10000, ms || (kind==='error'?5000:3000)));
                    const el = document.createElement('div');
                    el.className = 'pointer-events-auto w-[min(92vw,380px)] rounded-xl shadow-2xl ring-1 ring-white/50 bg-gradient-to-br from-[#A8E6CF]/80 to-white/90 backdrop-blur-md px-4 py-3 transition-all duration-300 ease-in-out translate-y-3 opacity-0';
                    const heading = kind==='success'?'Success':kind==='error'?'Error':kind==='warning'?'Warning':'Info';
                    el.innerHTML = '<div class="flex items-start gap-3">\
                        <div class="text-[#5A2753] text-xl">'+icon+'</div>\
                        <div class="flex-1">\
                          <div class="text-sm font-semibold text-[#5A2753]">'+heading+'</div>\
                          <div class="mt-0.5 text-[13px] leading-snug text-[#2E2E2E]">'+String(message||'')+'</div>\
                        </div>\
                        <button aria-label="Close" class="ml-2 text-[#5A2753]/70 hover:text-[#7A3E6C] transition-colors text-sm">√ó</button>\
                      </div>';
                    const closeBtn = el.querySelector('button');
                    function hide(){ el.style.opacity='0'; el.style.transform='translateY(8px)'; setTimeout(()=>{ try{toastContainer.removeChild(el)}catch(_){} },250); }
                    closeBtn.addEventListener('click', hide);
                    toastContainer.appendChild(el);
                    requestAnimationFrame(()=>{ el.style.opacity='1'; el.style.transform='translateY(0)'; });
                    setTimeout(hide, duration);
                }
                const nativeAlert = window.alert;
                window.alert = function(message){ try{ createToast('info', message); } catch(e){ try{ nativeAlert(message); } catch(_){} } };
                window.showAlert = function(type, message, opts){ createToast(type, message, opts && opts.duration); };
            } catch(_){}
        })();
    </script>
    <script>
        window.FIREBASE_CONFIG = {
          apiKey: "AIzaSyBs74HoIeuFoXE0G_mdD2eNBDsucuAEQCA",
          authDomain: "justclickshop-8081b.firebaseapp.com",
          projectId: "justclickshop-8081b",
          storageBucket: "justclickshop-8081b.firebasestorage.app",
          messagingSenderId: "623998776057",
          appId: "1:623998776057:web:f488332b7b49bbc3f5a828",
          measurementId: "G-DTDJ1CGMWB"
        };

        // Global variables for order data
        let allOrders = [];

        // Helper function to create print content
        function createPrintContent(orderId, order, items, total, time, customer) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Order Receipt - ${orderId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #5A2753; padding-bottom: 20px; margin-bottom: 30px; }
                        .order-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                        .customer-info { background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                        .items { margin-bottom: 20px; }
                        .total { font-size: 18px; font-weight: bold; text-align: right; border-top: 2px solid #5A2753; padding-top: 10px; }
                        .footer { text-align: center; margin-top: 30px; color: #666; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1 style="color: #5A2753; margin: 0;">Just Click by Sherry</h1>
                        <p style="margin: 5px 0; color: #666;">Order Receipt</p>
                    </div>
                    
                    <div class="order-info">
                        <h3 style="margin-top: 0; color: #5A2753;">Order Details</h3>
                        <p><strong>Order ID:</strong> ${orderId}</p>
                        <p><strong>Date:</strong> ${time}</p>
                        <p><strong>Status:</strong> ${order.status || 'Pending'}</p>
                    </div>
                    
                    ${(customer.name || customer.phone || customer.address || customer.facebook) ? `
                    <div class="customer-info">
                        <h3 style="margin-top: 0; color: #5A2753;">Customer Information</h3>
                        ${customer.name ? `<p><strong>Name:</strong> ${customer.name}</p>` : ''}
                        ${customer.phone ? `<p><strong>Phone:</strong> ${customer.phone}</p>` : ''}
                        ${customer.address ? `<p><strong>Address:</strong> ${customer.address}</p>` : ''}
                    </div>` : ''}
                    
                    <div class="items">
                        <h3 style="color: #5A2753;">Items Ordered</h3>
                        <div>${items || 'No items'}</div>
                    </div>
                    
                    <div class="total">
                        <strong>Total: ‚Ç±${total}</strong>
                    </div>
                    
                    <div class="footer">
                        <p>Thank you for your order!</p>
                        <p>Generated on ${new Date().toLocaleString()}</p>
                    </div>
                </body>
                </html>
            `;
        }

        // Print and Export Functions (Global scope)
        function printOrderAsPDF(orderId) {
            try {
                const order = (window.allOrders || allOrders).find(o => o.id === orderId);
                if (!order) {
                    alert('Order not found');
                    return;
                }
                
                const items = (order.items || []).map(i => `${i.name} (${i.size || 'One Size'}) √ó ${i.quantity} ‚Äî ‚Ç±${Number(i.price).toFixed(2)}`).join('<br>');
                const total = Number(order.total || 0).toFixed(2);
                const time = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleString() : new Date().toLocaleString();
                const customer = order.customer || {};
                
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (!printWindow || printWindow.closed || typeof printWindow.closed == 'undefined') {
                    // Fallback: create a temporary div and print it
                    const printContent = createPrintContent(orderId, order, items, total, time, customer);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = printContent;
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    tempDiv.style.top = '-9999px';
                    document.body.appendChild(tempDiv);
                    
                    const printWindow2 = window.open('', '_blank');
                    if (printWindow2) {
                        printWindow2.document.write(printContent);
                        printWindow2.document.close();
                        printWindow2.focus();
                        setTimeout(() => {
                            printWindow2.print();
                            setTimeout(() => printWindow2.close(), 1000);
                        }, 500);
                    } else {
                        // Last resort: use browser's print dialog
                        window.print();
                    }
                    document.body.removeChild(tempDiv);
                    return;
                }
                
                const printContent = createPrintContent(orderId, order, items, total, time, customer);
                printWindow.document.write(printContent);
                
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    setTimeout(() => printWindow.close(), 1000);
                }, 500);
            } catch (error) {
                console.error('Print error:', error);
                alert('Error generating print preview: ' + error.message);
            }
        }

        function exportOrderAsXML(orderId) {
            try {
                const order = (window.allOrders || allOrders).find(o => o.id === orderId);
                if (!order) {
                    alert('Order not found');
                    return;
                }
                
                const items = (order.items || []).map(i => 
                    `    <item>
        <name><![CDATA[${i.name || ''}]]></name>
        <size><![CDATA[${i.size || 'One Size'}]]></size>
        <quantity>${i.quantity || 0}</quantity>
        <price>${Number(i.price || 0).toFixed(2)}</price>
    </item>`
                ).join('\n');
                
                const customer = order.customer || {};
                const time = order.createdAt?.toDate ? order.createdAt.toDate().toISOString() : new Date().toISOString();
                
                const xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<order>
    <orderId><![CDATA[${orderId}]]></orderId>
    <date>${time}</date>
    <status><![CDATA[${order.status || 'Pending'}]]></status>
    <total>${Number(order.total || 0).toFixed(2)}</total>
    <customer>
        <name><![CDATA[${customer.name || ''}]]></name>
        <phone><![CDATA[${customer.phone || ''}]]></phone>
        <address><![CDATA[${customer.address || ''}]]></address>
    </customer>
    <items>
${items}
    </items>
    <generated>${new Date().toISOString()}</generated>
</order>`;
                
                const blob = new Blob([xmlContent], { type: 'application/xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `order-${orderId}-${new Date().toISOString().split('T')[0]}.xml`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('XML file downloaded successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting XML: ' + error.message);
            }
        }

        // Debug function to test if functions are accessible
        function testPrintExport() {
            console.log('Print function available:', typeof printOrderAsPDF);
            console.log('Export function available:', typeof exportOrderAsXML);
            console.log('All orders count:', (window.allOrders || allOrders).length);
            console.log('Sample order:', (window.allOrders || allOrders)[0]);
        }

        // Test function to create a sample order for testing
        function createTestOrder() {
            const testOrder = {
                id: 'test-' + Date.now(),
                items: [
                    { name: 'Test Product', size: 'Medium', quantity: 2, price: 299.99 }
                ],
                total: 599.98,
                status: 'Pending',
                customer: {
                    name: 'Test Customer',
                    phone: '123-456-7890',
                    address: '123 Test Street',
                },
                createdAt: { toDate: () => new Date() }
            };
            (window.allOrders || allOrders).unshift(testOrder);
            console.log('Test order created:', testOrder);
            return testOrder.id;
        }

        // Make functions globally accessible
        window.printOrderAsPDF = printOrderAsPDF;
        window.exportOrderAsXML = exportOrderAsXML;
        window.testPrintExport = testPrintExport;
        window.createTestOrder = createTestOrder;
    </script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, deleteDoc, updateDoc, doc, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

        const app = initializeApp(window.FIREBASE_CONFIG);
        const db = getFirestore(app);

        // Tabs
        const tabOrders = document.getElementById('tabOrders');
        const tabProducts = document.getElementById('tabProducts');
        const panelOrders = document.getElementById('panelOrders');
        const panelProducts = document.getElementById('panelProducts');
        function showPanel(which){
            const showOrders = which === 'orders';
            panelOrders.classList.toggle('hidden', !showOrders);
            panelProducts.classList.toggle('hidden', showOrders);
            tabOrders.classList.toggle('bg-plum-500', showOrders);
            tabOrders.classList.toggle('text-white', showOrders);
            tabOrders.classList.toggle('ring-1', !showOrders);
            tabOrders.classList.toggle('ring-slate-200', !showOrders);
            tabProducts.classList.toggle('bg-plum-500', !showOrders);
            tabProducts.classList.toggle('text-white', !showOrders);
            tabProducts.classList.toggle('ring-1', showOrders);
            tabProducts.classList.toggle('ring-slate-200', showOrders);
        }
        tabOrders.addEventListener('click', ()=>showPanel('orders'));
        tabProducts.addEventListener('click', ()=>showPanel('products'));

        // Orders realtime list + actions
        const ordersEl = document.getElementById('orders');
        const ordersRef = collection(db, 'orders');
        const ordersQuery = query(ordersRef, orderBy('createdAt', 'desc'));
        let curPage = 1;
        function applyFilters() {
            const q = (document.getElementById('searchInput').value || '').toLowerCase();
            const from = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
            const to = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value + 'T23:59:59') : null;
            let filtered = allOrders.filter(o => {
                 const customerName = (o.customer?.name || '');
        const text = (o.id + ' ' + customerName + ' ' + (o.items || []).map(i=>i.name).join(' ')).toLowerCase();
                if (q && !text.includes(q)) return false;
                if (from && o.createdAt && o.createdAt.toDate && o.createdAt.toDate() < from) return false;
                if (to && o.createdAt && o.createdAt.toDate && o.createdAt.toDate() > to) return false;
                return true;
            });
            const size = parseInt(document.getElementById('pageSize').value || '6', 10);
            const totalPages = Math.max(1, Math.ceil(filtered.length / size));
            if (curPage > totalPages) curPage = totalPages;
            const start = (curPage - 1) * size;
            const page = filtered.slice(start, start + size);
            renderOrders(page);
            document.getElementById('pageInfo').textContent = `Page ${curPage} / ${totalPages}`;
        }

        function statusBadge(status){
            const s = (status || 'pending').toLowerCase();
            if (s === 'completed' || s === 'complete') return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 ring-1 ring-green-200">Completed</span>';
            if (s === 'processing' || s === 'processed') return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 ring-1 ring-blue-200">Processing</span>';
            return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-700 ring-1 ring-amber-200">Pending</span>';
        }

        function renderOrders(list) {
            ordersEl.innerHTML = '';
            list.forEach(d => {
                const data = d;
                const items = (data.items || []).map(i => `${i.name} (${i.size || 'One Size'}) √ó ${i.quantity} ‚Äî ‚Ç±${Number(i.price).toFixed(2)}`).join('<br>');
                const total = Number(data.total || 0).toFixed(2);
                const time = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : '';
                const badge = statusBadge(data.status);
                const customer = data.customer || {};
                const card = document.createElement('div');
                card.className = 'p-5 rounded-2xl ring-1 ring-slate-100 shadow-sm bg-white';
                card.innerHTML = `
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <div class="text-sm text-slate-500">Order ID</div>
                            <div class="font-mono text-sm">${d.id}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-slate-500">Total</div>
                            <div class="font-semibold">‚Ç±${total}</div>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <div class="text-xs text-slate-500">${time}</div>
                        <div>${badge}</div>
                    </div>
                    ${(customer.name || customer.phone || customer.address || customer.facebook) ? `
                    <div class="mt-4 rounded-xl bg-slate-50 p-3 text-sm">
                        <div class="font-medium mb-1">Customer</div>
                        ${customer.name ? `<div><span class=\"text-slate-500\">Name:</span> ${customer.name}</div>` : ''}
                        ${customer.phone ? `<div><span class=\"text-slate-500\">Phone:</span> ${customer.phone}</div>` : ''}
                        ${customer.address ? `<div><span class=\"text-slate-500\">Address:</span> ${customer.address}</div>` : ''}
                        ${customer.facebook ? `<div><span class=\"text-slate-500\">Facebook:</span> ${customer.facebook}</div>` : ''}
                    </div>` : ''}
                    <div class="mt-4 text-sm">${items || 'No items'}</div>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button class="updateOrder rounded-full px-3 py-1 ring-1 ring-slate-200 hover:ring-plum-500">Mark Processed</button>
                        <button class="deleteOrder text-red-600 rounded-full px-3 py-1 ring-1 ring-red-200 hover:bg-red-50">Delete</button>
                        <button onclick="printOrderAsPDF('${d.id}')" class="bg-rose-600 text-white px-3 py-1 rounded-full hover:bg-rose-700 transition text-xs">
                            üñ®Ô∏è Print PDF
                        </button>
                        <button onclick="exportOrderAsXML('${d.id}')" class="bg-slate-600 text-white px-3 py-1 rounded-full hover:bg-slate-700 transition text-xs">
                            üíæ Export XML
                        </button>
                    </div>`;
                card.querySelector('.deleteOrder').addEventListener('click', async () => {
                    const ok = confirm('Delete this order permanently?');
                    if (!ok) return;
                    await deleteDoc(doc(db, 'orders', d.id));
                });
                card.querySelector('.updateOrder').addEventListener('click', async () => {
                    await updateDoc(doc(db, 'orders', d.id), { status: 'processed' });
                });
                ordersEl.appendChild(card);
            });
        }

        onSnapshot(ordersQuery, (snap) => {
            window.allOrders = [];
            snap.forEach(docSnap => window.allOrders.push({ id: docSnap.id, ...docSnap.data() }));
            allOrders = window.allOrders; // Update local reference
            curPage = 1;
            applyFilters();
        });

        document.getElementById('searchInput').addEventListener('input', () => { curPage = 1; applyFilters(); });
        document.getElementById('dateFrom').addEventListener('change', () => { curPage = 1; applyFilters(); });
        document.getElementById('dateTo').addEventListener('change', () => { curPage = 1; applyFilters(); });
        document.getElementById('pageSize').addEventListener('change', () => { curPage = 1; applyFilters(); });
        document.getElementById('prevPage').addEventListener('click', () => { if (curPage > 1) { curPage--; applyFilters(); } });
        document.getElementById('nextPage').addEventListener('click', () => { curPage++; applyFilters(); });

        // Products CRUD
        const productsRef = collection(db, 'products');
        const productsList = document.getElementById('productsList');
        async function renderProductsAdmin(){
            const snap = await getDocs(productsRef);
            productsList.innerHTML = '';
            snap.forEach(d => {
                const p = d.data();
                const card = document.createElement('div');
                card.className = 'p-5 rounded-2xl ring-1 ring-slate-100 shadow-sm flex gap-4 bg-white';
                 card.innerHTML = `
                     <img src="${p.image || 'https://placehold.co/120x90'}" class="w-24 h-20 rounded-lg object-cover"/>
                     <div class="flex-1">
                         <div class="font-medium">${p.name}</div>
                         <div class="text-sm text-slate-500">${p.category || ''}</div>
                         <div class="text-sm text-slate-600">
          <span>${Array.isArray(p.size) && p.size.length > 1 ? 'Sizes: ' + p.size.join(' ‚Ä¢ ') : 'Size: ' + ((p.size && p.size[0]) || 'One Size')}</span>
        </div>
                         <div class="mt-1 font-semibold">‚Ç±${Number(p.price||0).toFixed(2)}</div>
                         <div class="mt-2 flex items-center gap-2">
                             <span class="text-sm font-medium ${Number(p.stock || 0) > 0 ? 'text-green-600' : 'text-red-600'}">
                                 Stock: ${Number(p.stock || 0)}
                             </span>
                             ${Number(p.stock || 0) === 0 ? '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full">Out of Stock</span>' : ''}
                         </div>
                         <div class="mt-3 flex flex-wrap gap-2">
                             <button class="edit rounded-full px-3 py-1 ring-1 ring-slate-200 hover:ring-plum-500">Edit</button>
                             <button class="remove text-red-600 rounded-full px-3 py-1 ring-1 ring-red-200 hover:bg-red-50">Delete</button>
                         </div>
                     </div>`;
                card.querySelector('.remove').addEventListener('click', async ()=>{
                    const ok = confirm('Delete this product permanently?');
                    if (!ok) return;
                    await deleteDoc(doc(db, 'products', d.id));
                    renderProductsAdmin();
                });
                card.querySelector('.edit').addEventListener('click', ()=> openProductModal({ id: d.id, ...p }));
                productsList.appendChild(card);
            });
        }

        // Add/Edit modal
        const modalHtml = document.createElement('div');
        modalHtml.innerHTML = `
        <div id="productModal" class="fixed inset-0 hidden items-center justify-center bg-black/30">
  <div class="bg-white rounded-2xl p-6 w-[90%] max-w-md shadow-xl">
    <h3 class="text-lg font-semibold" id="pmTitle">Add Product</h3>
     <div class="grid gap-3 mt-3">
       <input id="pmName" class="px-4 py-3 rounded-xl ring-1 ring-slate-200 focus:outline-none focus:ring-plum-500" placeholder="Name">
       <input id="pmPrice" type="number" step="0.01" class="px-4 py-3 rounded-xl ring-1 ring-slate-200 focus:outline-none focus:ring-plum-500" placeholder="Price">
       <input id="pmCategory" class="px-4 py-3 rounded-xl ring-1 ring-slate-200 focus:outline-none focus:ring-plum-500" placeholder="Category (clothes/lip-tint/dress/full/top/perfume/accessory/pants/package/sweater)">
       <input id="pmSize" class="px-4 py-3 rounded-xl ring-1 ring-slate-200 focus:outline-none focus:ring-plum-500" placeholder="Size(s) e.g. Small, Medium, Large">
       <input id="pmStock" type="number" min="0" class="px-4 py-3 rounded-xl ring-1 ring-slate-200 focus:outline-none focus:ring-plum-500" placeholder="Stock Quantity">
       <input id="pmImage" class="px-4 py-3 rounded-xl ring-1 ring-slate-200 focus:outline-none focus:ring-plum-500" placeholder="Image URL">
     </div>
    <div class="mt-4 flex gap-2 justify-end">
      <button id="pmCancel" class="px-4 py-2 rounded-full ring-1 ring-slate-200">Cancel</button>
      <button id="pmSave" class="px-5 py-2 rounded-full bg-plum-500 text-white hover:bg-plum-600">Save</button>
    </div>
  </div>
</div>`;
        document.body.appendChild(modalHtml);
        const productModal = document.getElementById('productModal');
         function openProductModal(product){
             productModal.classList.remove('hidden');
             productModal.classList.add('flex');
             document.getElementById('pmTitle').textContent = product?.id ? 'Edit Product' : 'Add Product';
             document.getElementById('pmName').value = product?.name || '';
             document.getElementById('pmPrice').value = product?.price || '';
             document.getElementById('pmCategory').value = product?.category || '';
             document.getElementById('pmSize').value = Array.isArray(product?.size) ? product.size.join(', ') : (product?.size || '');
             document.getElementById('pmStock').value = product?.stock || '';
             document.getElementById('pmImage').value = product?.image || '';
             document.getElementById('pmSave').onclick = async () => {
                 const payload = {
                     name: document.getElementById('pmName').value.trim(),
                     price: parseFloat(document.getElementById('pmPrice').value || '0'),
                     category: document.getElementById('pmCategory').value.trim(),
                     size: (function(){
                         const raw = (document.getElementById('pmSize').value || '').trim();
                         if (!raw) return ['One Size'];
                         return raw.split(',').map(s=>s.trim()).filter(Boolean);
                     })(),
                     stock: parseInt(document.getElementById('pmStock').value || '0'),
                     image: document.getElementById('pmImage').value.trim()
                 };
                 if (!payload.name) { alert('Name is required'); return; }
                 if (payload.stock < 0) { alert('Stock quantity cannot be negative'); return; }
                 try {
                     if (product?.id) {
                         await updateDoc(doc(db, 'products', product.id), payload);
                     } else {
                         await addDoc(productsRef, payload);
                     }
                     closeProductModal();
                     await renderProductsAdmin();
                     showPanel('products');
                 } catch (e) {
                     console.error(e);
                     alert('Failed to save product: ' + (e.message || e));
                 }
             };
         }
        function closeProductModal(){
            productModal.classList.add('hidden');
            productModal.classList.remove('flex');
        }
        document.getElementById('pmCancel')?.addEventListener('click', closeProductModal);
        document.getElementById('addProductBtn').addEventListener('click', ()=> openProductModal(null));
        document.getElementById('refreshOrders').addEventListener('click', ()=>{});

        // Initial renders
        renderProductsAdmin();

        document.getElementById('goToStartBtn').addEventListener('click', function() {
            const ok = confirm('Are you sure you want to logout of admin mode?');
            if (!ok) return;
            try { localStorage.removeItem('jcws_admin'); localStorage.removeItem('adminAuth'); } catch {}
            window.location.href = './start.html';
        });

    </script>
</body>
</html>
